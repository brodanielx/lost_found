{% extends 'contacts/base_bootstrap.html' %}

{% load staticfiles %}
{% load humanize %}
{% load djng_tags %}

{% block body_block %}

<script type="text/javascript">
  var app = angular.module('myApp', []);
  app.controller('myCtrl', function($scope, $http) {

      $scope.initialize = () => {
        $scope.setDesc();
        $scope.sortContacts('created_at', 4);
      }
      $scope.sortContacts = (sortkey, i) => {
        console.log('sortkey: ', sortkey);
        if ($scope.ordersByHeaders) {
          let headerDescObj = $scope.ordersByHeaders.filter(item => {
            return item.column === sortkey
          })[0]
          let isDesc = headerDescObj.desc
          if (isDesc) {
            sortkey = `-${sortkey}`
          }
          $scope.ordersByHeaders.forEach(header => {
            header.desc = false
          })
          $scope.ordersByHeaders[i].desc = !isDesc
        }
        let endpoint = `api/recently_added/${sortkey}/`
        $http.get(endpoint)
          .then(res => {
            $scope.contacts = res.data
          }).catch(res => {
            console.log(res);
          })
      }
      $scope.setDesc = () => {
        $scope.ordersByHeaders = []
        let headers = document.querySelectorAll('.grid-header')
        let descBool
        headers.forEach(header => {
          if (header.id === 'created_at') {
            descBool = true
          } else {
            descBool = false
          }
          $scope.ordersByHeaders.push({
            column: header.id,
            desc: descBool
          })
        })
      }

  });
</script>

<div ng-app="myApp" ng-controller="myCtrl" ng-init="initialize()">
  <div class="jumbotron jumbotron-fluid">
  <div class="container">
    <h1 class="display-4 jumbo-h1">Tampa Lost Founds</h1>
    <div class="row">
      <div class="col-sm-4">
        <p class="lead">Total Lost Founds Added: {{ total_contacts }}</p>
      </div>
      <div class="col-sm-4">
        <p class="lead">Lost Founds in Tampa: {{ black_population|intcomma }}</p>
      </div>
      <div class="col-sm-4">
        <p class="lead">Percent in Database: {{ percent_lf_added }} %</p>
      </div>
    </div>
  </div>
</div>


<div class="container">
  <h4 class="lead">
    Recently Added by {{ user.first_name }} {{ user.last_name }}
  </h4>
  <table class="table table-hover">
    {% angularjs %}
  <thead>
    <tr>
      <th>#</th>
      <th class="grid-header"
          ng-click="sortContacts('gender', 0)"
          id="gender">
        Gender
      </th>
      <th class="grid-header"
          ng-click="sortContacts('full_name', 1)"
          id="full_name">
        Name
      </th>
      <th class="grid-header"
          ng-click="sortContacts('phone_number_formated', 2)"
          id="phone_number_formated">
        Phone #
      </th>
      <th class="grid-header"
          ng-click="sortContacts('email', 3)"
          id="email">
        Email
      </th>
      <th class="grid-header"
          ng-click="sortContacts('created_at', 4)"
          id="created_at">
        Date Added
      </th>
      <th>Edit</th>
    </tr>
  </thead>
  <tbody>

    <tr ng-repeat="contact in contacts">
      <th>{{ contact.pk }}</th>
      <td>{{ contact.fields.gender }}</td>
      <td>
        <a ng-href="contact/{{contact.pk}}/">{{ contact.fields.full_name }}</a>
      </td>
      <td>{{ contact.fields.phone_number_formated }}</td>
      <td>{{ contact.fields.email }}</td>
      <td>{{ contact.fields.created_at | date:"shortDate" }}</td>
      <td>
        <a ng-href="editcontact/{{contact.pk}}/">
          <i class="fa fa-pencil-square-o fa-lg" aria-hidden="true"></i>
        </a>
      </td>
    </tr>

  </tbody>
  {% endangularjs %}
</table>
</div>
</div>
{% endblock %}
